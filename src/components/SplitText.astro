---
interface Props {
  text: string;
  tag?: 'h1' | 'h2' | 'h3' | 'h4' | 'p' | 'span';
  class?: string;
  splitBy?: 'chars' | 'words';
  delay?: number;
  stagger?: number;
}

const {
  text,
  tag = 'p',
  class: className = '',
  splitBy = 'chars',
  delay = 0,
  stagger = 30
} = Astro.props;

const Tag = tag;

const splitText = () => {
  if (splitBy === 'words') {
    return text.split(' ').map((word, i) => ({
      content: word,
      delay: delay + (i * stagger)
    }));
  }
  return text.split('').map((char, i) => ({
    content: char === ' ' ? '\u00A0' : char,
    delay: delay + (i * stagger)
  }));
};

const elements = splitText();
---

<Tag class:list={["split-text", className]} data-split-text>
  {elements.map((el, index) => (
    <span
      class="split-char"
      style={`--char-delay: ${el.delay}ms`}
      data-index={index}
    >
      {el.content}
    </span>
  ))}
</Tag>

<style>
  .split-text {
    display: inline-block;
  }

  .split-char {
    display: inline-block;
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    transition-delay: var(--char-delay);
  }

  .split-text.is-visible .split-char {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  const initSplitText = () => {
    const elements = document.querySelectorAll('[data-split-text]');

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.2, rootMargin: '-50px' }
    );

    elements.forEach((el) => observer.observe(el));
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSplitText);
  } else {
    initSplitText();
  }
</script>
