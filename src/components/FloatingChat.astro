---
import { Icon } from "astro-icon/components";

interface Props {
  agentName?: string;
  agentRole?: string;
  welcomeMessage?: string;
  placeholder?: string;
}

const {
  agentName = "Sofia",
  agentRole = "Asesora de Envios",
  welcomeMessage = "Hola! Soy Sofia, tu asesora de envios. Como puedo ayudarte hoy?",
  placeholder = "Escribe tu mensaje...",
} = Astro.props;
---

<div id="floating-chat" class="fixed bottom-6 right-6 z-50 font-sans">
  <button
    id="chat-toggle"
    aria-label="Abrir chat de atencion al cliente"
    class="group relative w-16 h-16 bg-gradient-to-br from-verde-global-500 to-verde-global-600 hover:from-verde-global-400 hover:to-verde-global-500 rounded-full shadow-lg shadow-verde-global-500/30 hover:shadow-xl hover:shadow-verde-global-500/40 transition-all duration-300 flex items-center justify-center"
  >
    <Icon
      name="tabler:message-circle-2-filled"
      id="chat-icon-open"
      class="w-7 h-7 text-white transition-transform duration-300"
    />
    <Icon
      name="tabler:x"
      id="chat-icon-close"
      class="w-7 h-7 text-white absolute opacity-0 scale-50 transition-all duration-300"
    />
    <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse" id="chat-notification"></span>
  </button>

  <div
    id="chat-window"
    class="absolute bottom-20 right-0 w-[360px] max-w-[calc(100vw-2rem)] bg-white rounded-2xl shadow-2xl shadow-azul-marino-950/20 overflow-hidden opacity-0 scale-95 origin-bottom-right pointer-events-none transition-all duration-300"
  >
    <div class="bg-gradient-to-r from-azul-marino-900 to-azul-marino-800 p-4">
      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="w-12 h-12 bg-verde-global-500 rounded-full flex items-center justify-center">
            <Icon name="tabler:headset" class="w-6 h-6 text-white" />
          </div>
          <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-azul-marino-900"></span>
        </div>
        <div class="flex-1">
          <h3 class="text-white font-bold text-sm">{agentName}</h3>
          <p class="text-azul-oceano-300 text-xs">{agentRole}</p>
        </div>
        <button
          id="chat-minimize"
          aria-label="Minimizar chat"
          class="w-8 h-8 hover:bg-white/10 rounded-lg flex items-center justify-center transition-colors"
        >
          <Icon name="tabler:minus" class="w-5 h-5 text-white" />
        </button>
      </div>
    </div>

    <div
      id="chat-messages"
      class="h-80 overflow-y-auto p-4 space-y-4 bg-gray-50"
    >
      <div class="flex gap-3 chat-message-agent">
        <div class="w-8 h-8 bg-verde-global-500 rounded-full flex-shrink-0 flex items-center justify-center">
          <Icon name="tabler:headset" class="w-4 h-4 text-white" />
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]">
          <p class="text-azul-marino-800 text-sm leading-relaxed">{welcomeMessage}</p>
          <span class="text-azul-marino-400 text-xs mt-1 block">Ahora</span>
        </div>
      </div>
    </div>

    <div class="p-4 bg-white border-t border-gray-100">
      <div class="flex items-center gap-2 bg-gray-50 rounded-xl p-2">
        <button
          id="chat-attach"
          aria-label="Adjuntar archivo"
          class="w-9 h-9 hover:bg-gray-200 rounded-lg flex items-center justify-center transition-colors text-azul-marino-400 hover:text-azul-marino-600"
        >
          <Icon name="tabler:paperclip" class="w-5 h-5" />
        </button>
        <input
          type="text"
          id="chat-input"
          placeholder={placeholder}
          class="flex-1 bg-transparent text-azul-marino-800 text-sm placeholder-azul-marino-400 outline-none"
        />
        <button
          id="chat-send"
          aria-label="Enviar mensaje"
          class="w-9 h-9 bg-verde-global-500 hover:bg-verde-global-400 rounded-lg flex items-center justify-center transition-colors text-white disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <Icon name="tabler:send" class="w-5 h-5" />
        </button>
      </div>
      <p class="text-center text-azul-marino-400 text-xs mt-3">
        Respuesta tipica en menos de 5 minutos
      </p>
    </div>
  </div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const chatToggle = document.getElementById('chat-toggle');
    const chatWindow = document.getElementById('chat-window');
    const chatMinimize = document.getElementById('chat-minimize');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatMessages = document.getElementById('chat-messages');
    const chatIconOpen = document.getElementById('chat-icon-open');
    const chatIconClose = document.getElementById('chat-icon-close');
    const chatNotification = document.getElementById('chat-notification');

    let isOpen = false;

    function toggleChat() {
      isOpen = !isOpen;

      if (isOpen) {
        chatWindow.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        chatWindow.classList.add('opacity-100', 'scale-100');
        chatIconOpen.classList.add('opacity-0', 'scale-50');
        chatIconClose.classList.remove('opacity-0', 'scale-50');
        chatNotification.classList.add('hidden');
        chatInput.focus();
      } else {
        chatWindow.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
        chatWindow.classList.remove('opacity-100', 'scale-100');
        chatIconOpen.classList.remove('opacity-0', 'scale-50');
        chatIconClose.classList.add('opacity-0', 'scale-50');
      }
    }

    chatToggle.addEventListener('click', toggleChat);
    chatMinimize.addEventListener('click', toggleChat);

    chatInput.addEventListener('input', () => {
      chatSend.disabled = chatInput.value.trim() === '';
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && chatInput.value.trim()) {
        sendMessage();
      }
    });

    chatSend.addEventListener('click', sendMessage);

    function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      addMessage(message, 'user');
      chatInput.value = '';
      chatSend.disabled = true;

      setTimeout(() => {
        addMessage(getAutoResponse(message), 'agent');
      }, 1000);
    }

    function addMessage(text, type) {
      const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

      const messageHTML = type === 'user'
        ? `<div class="flex gap-3 justify-end chat-message-user">
            <div class="bg-verde-global-500 rounded-2xl rounded-tr-sm p-3 shadow-sm max-w-[80%]">
              <p class="text-white text-sm leading-relaxed">${text}</p>
              <span class="text-verde-global-200 text-xs mt-1 block text-right">${time}</span>
            </div>
          </div>`
        : `<div class="flex gap-3 chat-message-agent">
            <div class="w-8 h-8 bg-verde-global-500 rounded-full flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14v-3a8 8 0 1 1 16 0v3M18 19c0 1.657 -2.686 3 -6 3s-6 -1.343 -6 -3M4 14a2 2 0 0 1 2 -2h1a2 2 0 0 1 2 2v3a2 2 0 0 1 -2 2h-1a2 2 0 0 1 -2 -2v-3zM15 14a2 2 0 0 1 2 -2h1a2 2 0 0 1 2 2v3a2 2 0 0 1 -2 2h-1a2 2 0 0 1 -2 -2v-3z"/></svg>
            </div>
            <div class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]">
              <p class="text-azul-marino-800 text-sm leading-relaxed">${text}</p>
              <span class="text-azul-marino-400 text-xs mt-1 block">${time}</span>
            </div>
          </div>`;

      chatMessages.insertAdjacentHTML('beforeend', messageHTML);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function getAutoResponse(message) {
      const lower = message.toLowerCase();

      if (lower.includes('precio') || lower.includes('costo') || lower.includes('cotiza')) {
        return 'Para darte una cotizacion precisa necesito saber: origen, destino, tipo de mercancia y peso aproximado. Puedes tambien usar nuestro cotizador online en la seccion de servicios.';
      }
      if (lower.includes('rastreo') || lower.includes('rastrear') || lower.includes('tracking')) {
        return 'Puedes rastrear tu envio en nuestra pagina de Rastreo con tu numero de guia. Si no lo tienes, proporcioname tu nombre o numero de pedido y lo busco.';
      }
      if (lower.includes('tiempo') || lower.includes('demora') || lower.includes('llegar')) {
        return 'Los tiempos de entrega varian: Maritimo 15-30 dias, Aereo 3-7 dias, Terrestre 1-5 dias segun destino. Quieres que te de informacion mas especifica?';
      }
      if (lower.includes('horario') || lower.includes('atencion')) {
        return 'Nuestro horario de atencion es Lunes a Viernes de 9:00 a 18:00 y Sabados de 9:00 a 13:00. Tambien puedes llamarnos al +34 555 540 069.';
      }
      if (lower.includes('hola') || lower.includes('buenos') || lower.includes('buenas')) {
        return 'Hola! Encantada de atenderte. En que puedo ayudarte hoy? Puedo asistirte con cotizaciones, rastreo de envios, tiempos de entrega o cualquier otra consulta.';
      }

      return 'Gracias por tu mensaje. Un agente revisara tu consulta y te respondera pronto. Mientras tanto, puedes llamarnos al +34 555 540 069 para atencion inmediata.';
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        toggleChat();
      }
    });
  });
</script>
