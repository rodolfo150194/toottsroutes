---
import { Icon } from "astro-icon/components";

interface Props {
  agentName?: string;
  agentRole?: string;
  welcomeMessage?: string;
  placeholder?: string;
  webhookUrl?: string;
}

const {
  agentName = "Sofia",
  agentRole = "Asesora de Envios",
  welcomeMessage = "Hola! Soy Sofia, tu asesora de envios. Como puedo ayudarte hoy?",
  placeholder = "Escribe tu mensaje...",
  webhookUrl = "",
} = Astro.props;
---

<div id="floating-chat" class="fixed bottom-6 right-6 z-50 font-sans" data-webhook={webhookUrl}>
  <button
    id="chat-toggle"
    aria-label="Abrir chat de atencion al cliente"
    class="group relative w-16 h-16 bg-gradient-to-br from-verde-global-500 to-verde-global-600 hover:from-verde-global-400 hover:to-verde-global-500 rounded-full shadow-lg shadow-verde-global-500/30 hover:shadow-xl hover:shadow-verde-global-500/40 transition-all duration-300 flex items-center justify-center"
  >
    <Icon
      name="tabler:message-circle-2-filled"
      id="chat-icon-open"
      class="w-7 h-7 text-white transition-transform duration-300"
    />
    <Icon
      name="tabler:x"
      id="chat-icon-close"
      class="w-7 h-7 text-white absolute opacity-0 scale-50 transition-all duration-300"
    />
    <span class="absolute -top-1 -right-1 min-w-5 h-5 bg-red-500 rounded-full border-2 border-white text-white text-[10px] font-bold flex items-center justify-center px-1 animate-pulse" id="chat-notification"></span>
  </button>

  <div
    id="chat-window"
    class="absolute bottom-20 right-0 w-[420px] max-w-[calc(100vw-2rem)] bg-white rounded-2xl shadow-2xl shadow-azul-marino-950/20 overflow-hidden opacity-0 scale-95 origin-bottom-right pointer-events-none transition-all duration-300"
  >
    <div class="bg-gradient-to-r from-azul-marino-900 to-azul-marino-800 p-4">
      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="w-12 h-12 bg-verde-global-500 rounded-full flex items-center justify-center">
            <Icon name="tabler:headset" class="w-6 h-6 text-white" />
          </div>
          <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-azul-marino-900"></span>
        </div>
        <div class="flex-1">
          <h3 class="text-white font-bold text-sm">{agentName}</h3>
          <p class="text-azul-oceano-300 text-xs">{agentRole}</p>
        </div>
        <button
          id="chat-minimize"
          aria-label="Minimizar chat"
          class="w-8 h-8 hover:bg-white/10 rounded-lg flex items-center justify-center transition-colors"
        >
          <Icon name="tabler:minus" class="w-5 h-5 text-white" />
        </button>
      </div>
    </div>

    <div
      id="chat-messages"
      class="h-80 overflow-y-auto p-4 space-y-4 bg-gray-50"
    >
      <div class="flex gap-3 chat-message-agent">
        <div class="w-8 h-8 bg-verde-global-500 rounded-full flex-shrink-0 flex items-center justify-center">
          <Icon name="tabler:headset" class="w-4 h-4 text-white" />
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]">
          <p class="text-azul-marino-800 text-sm leading-relaxed">{welcomeMessage}</p>
          <span class="text-azul-marino-400 text-xs mt-1 block">Ahora</span>
        </div>
      </div>
    </div>

    <div class="p-4 bg-white border-t border-gray-100">
      <div class="flex items-center gap-2 bg-gray-50 rounded-xl p-2">
        <button
          id="chat-attach"
          aria-label="Adjuntar archivo"
          class="w-9 h-9 hover:bg-gray-200 rounded-lg flex items-center justify-center transition-colors text-azul-marino-400 hover:text-azul-marino-600"
        >
          <Icon name="tabler:paperclip" class="w-5 h-5" />
        </button>
        <input
          type="text"
          id="chat-input"
          placeholder={placeholder}
          class="flex-1 bg-transparent text-azul-marino-800 text-sm placeholder-azul-marino-400 outline-none"
        />
        <button
          id="chat-send"
          aria-label="Enviar mensaje"
          class="w-9 h-9 bg-verde-global-500 hover:bg-verde-global-400 rounded-lg flex items-center justify-center transition-colors text-white disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <Icon name="tabler:send" class="w-5 h-5" />
        </button>
      </div>
      <p class="text-center text-azul-marino-400 text-xs mt-3">
        Respuesta tipica en menos de 5 minutos
      </p>
    </div>
  </div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const floatingChat = document.getElementById('floating-chat');
    const chatToggle = document.getElementById('chat-toggle');
    const chatWindow = document.getElementById('chat-window');
    const chatMinimize = document.getElementById('chat-minimize');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const chatMessages = document.getElementById('chat-messages');
    const chatIconOpen = document.getElementById('chat-icon-open');
    const chatIconClose = document.getElementById('chat-icon-close');
    const chatNotification = document.getElementById('chat-notification');

    const webhookUrl = floatingChat.dataset.webhook || '';
    const STORAGE_KEY = 'rootts_chat_history';
    const SESSION_KEY = 'rootts_chat_session';
    const STORAGE_EXPIRY = 24 * 60 * 60 * 1000; // 24 horas

    let isOpen = false;
    let isLoading = false;
    let conversationHistory = [];
    let unreadCount = 0;
    let sessionId = getOrCreateSessionId();

    function getOrCreateSessionId() {
      let id = localStorage.getItem(SESSION_KEY);
      if (!id) {
        id = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem(SESSION_KEY, id);
      }
      return id;
    }

    // Sonido de notificacion usando Web Audio API
    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        // Audio no soportado, ignorar
      }
    }

    // Guardar conversacion en localStorage
    function saveConversation() {
      try {
        const data = {
          history: conversationHistory,
          messages: chatMessages.innerHTML,
          timestamp: Date.now()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        // localStorage no disponible
      }
    }

    // Cargar conversacion de localStorage
    function loadConversation() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return false;

        const data = JSON.parse(stored);

        // Verificar si expiro (24 horas)
        if (Date.now() - data.timestamp > STORAGE_EXPIRY) {
          localStorage.removeItem(STORAGE_KEY);
          return false;
        }

        if (data.history && data.history.length > 0) {
          conversationHistory = data.history;
          chatMessages.innerHTML = data.messages;
          return true;
        }
      } catch (e) {
        // Error al cargar, ignorar
      }
      return false;
    }

    // Limpiar conversacion
    function clearConversation() {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(SESSION_KEY);
      conversationHistory = [];
      sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem(SESSION_KEY, sessionId);
    }

    // Mostrar notificacion (badge + sonido)
    function showNotification() {
      if (!isOpen) {
        unreadCount++;
        chatNotification.classList.remove('hidden');
        chatNotification.textContent = unreadCount > 9 ? '9+' : unreadCount;
        playNotificationSound();

        // Vibrar en moviles si esta disponible
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }
      }
    }

    // Ocultar notificacion
    function hideNotification() {
      unreadCount = 0;
      chatNotification.classList.add('hidden');
    }

    // Cargar conversacion al iniciar
    const hasHistory = loadConversation();
    if (!hasHistory) {
      chatNotification.classList.add('hidden');
    } else {
      // Si hay historial, ocultar notificacion inicial
      chatNotification.classList.add('hidden');
    }

    function toggleChat() {
      isOpen = !isOpen;

      if (isOpen) {
        chatWindow.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        chatWindow.classList.add('opacity-100', 'scale-100');
        chatIconOpen.classList.add('opacity-0', 'scale-50');
        chatIconClose.classList.remove('opacity-0', 'scale-50');
        hideNotification();
        chatInput.focus();
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } else {
        chatWindow.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
        chatWindow.classList.remove('opacity-100', 'scale-100');
        chatIconOpen.classList.remove('opacity-0', 'scale-50');
        chatIconClose.classList.add('opacity-0', 'scale-50');
      }
    }

    chatToggle.addEventListener('click', toggleChat);
    chatMinimize.addEventListener('click', toggleChat);

    chatInput.addEventListener('input', () => {
      chatSend.disabled = chatInput.value.trim() === '' || isLoading;
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && chatInput.value.trim() && !isLoading) {
        sendMessage();
      }
    });

    chatSend.addEventListener('click', sendMessage);

    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message || isLoading) return;

      addMessage(message, 'user');
      conversationHistory.push({ role: 'user', content: message });
      saveConversation();
      chatInput.value = '';
      chatSend.disabled = true;
      isLoading = true;

      showTypingIndicator();

      try {
        const response = await getAIResponse(message);
        removeTypingIndicator();
        addMessage(response, 'agent');
        conversationHistory.push({ role: 'assistant', content: response });
        saveConversation();
        showNotification();
      } catch (error) {
        console.error('Chat error:', error);
        removeTypingIndicator();
        const errorMsg = 'Lo siento, hubo un error al procesar tu mensaje. Por favor intenta de nuevo o llamanos al +34 555 540 069.';
        addMessage(errorMsg, 'agent');
        conversationHistory.push({ role: 'assistant', content: errorMsg });
        saveConversation();
        showNotification();
      }

      isLoading = false;
    }

    function showTypingIndicator() {
      const typingHTML = `
        <div id="typing-indicator" class="flex gap-3 chat-message-agent">
          <div class="w-8 h-8 bg-verde-global-500 rounded-full flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14v-3a8 8 0 1 1 16 0v3M18 19c0 1.657 -2.686 3 -6 3s-6 -1.343 -6 -3M4 14a2 2 0 0 1 2 -2h1a2 2 0 0 1 2 2v3a2 2 0 0 1 -2 2h-1a2 2 0 0 1 -2 -2v-3zM15 14a2 2 0 0 1 2 -2h1a2 2 0 0 1 2 2v3a2 2 0 0 1 -2 2h-1a2 2 0 0 1 -2 -2v-3z"/></svg>
          </div>
          <div class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm">
            <div class="flex gap-1">
              <span class="w-2 h-2 bg-azul-marino-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
              <span class="w-2 h-2 bg-azul-marino-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
              <span class="w-2 h-2 bg-azul-marino-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
            </div>
          </div>
        </div>`;
      chatMessages.insertAdjacentHTML('beforeend', typingHTML);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) indicator.remove();
    }

    async function getAIResponse(message) {
      if (!webhookUrl) {
        return getFallbackResponse(message);
      }

      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          sessionId: sessionId,
          message: message,
          history: conversationHistory,
          metadata: {
            page: window.location.pathname,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
          }
        }),
      });

      if (!response.ok) {
        console.error('HTTP error:', response.status, response.statusText);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('n8n response:', data);
      return data.output || data.response || data.message || data.text || 'Gracias por tu mensaje.';
    }

    function getFallbackResponse(message) {
      const lower = message.toLowerCase();

      if (lower.includes('precio') || lower.includes('costo') || lower.includes('cotiza')) {
        return 'Para darte una cotizacion precisa necesito saber: origen, destino, tipo de mercancia y peso aproximado. Puedes tambien usar nuestro cotizador online en la seccion de servicios.';
      }
      if (lower.includes('rastreo') || lower.includes('rastrear') || lower.includes('tracking')) {
        return 'Puedes rastrear tu envio en nuestra pagina de Rastreo con tu numero de guia. Si no lo tienes, proporcioname tu nombre o numero de pedido y lo busco.';
      }
      if (lower.includes('tiempo') || lower.includes('demora') || lower.includes('llegar')) {
        return 'Los tiempos de entrega varian: Maritimo 15-30 dias, Aereo 3-7 dias, Terrestre 1-5 dias segun destino. Quieres que te de informacion mas especifica?';
      }
      if (lower.includes('horario') || lower.includes('atencion')) {
        return 'Nuestro horario de atencion es Lunes a Viernes de 9:00 a 18:00 y Sabados de 9:00 a 13:00. Tambien puedes llamarnos al +34 555 540 069.';
      }
      if (lower.includes('hola') || lower.includes('buenos') || lower.includes('buenas')) {
        return 'Hola! Encantada de atenderte. En que puedo ayudarte hoy? Puedo asistirte con cotizaciones, rastreo de envios, tiempos de entrega o cualquier otra consulta.';
      }

      return 'Gracias por tu mensaje. Un agente revisara tu consulta y te respondera pronto. Mientras tanto, puedes llamarnos al +34 555 540 069 para atencion inmediata.';
    }

    function addMessage(text, type) {
      const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

      const messageHTML = type === 'user'
        ? `<div class="flex gap-3 justify-end chat-message-user">
            <div class="bg-verde-global-500 rounded-2xl rounded-tr-sm p-3 shadow-sm max-w-[80%]">
              <p class="text-white text-sm leading-relaxed">${escapeHtml(text)}</p>
              <span class="text-verde-global-200 text-xs mt-1 block text-right">${time}</span>
            </div>
          </div>`
        : `<div class="flex gap-3 chat-message-agent">
            <div class="w-8 h-8 bg-verde-global-500 rounded-full flex-shrink-0 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14v-3a8 8 0 1 1 16 0v3M18 19c0 1.657 -2.686 3 -6 3s-6 -1.343 -6 -3M4 14a2 2 0 0 1 2 -2h1a2 2 0 0 1 2 2v3a2 2 0 0 1 -2 2h-1a2 2 0 0 1 -2 -2v-3zM15 14a2 2 0 0 1 2 -2h1a2 2 0 0 1 2 2v3a2 2 0 0 1 -2 2h-1a2 2 0 0 1 -2 -2v-3z"/></svg>
            </div>
            <div class="bg-white rounded-2xl rounded-tl-sm p-3 shadow-sm max-w-[80%]">
              <p class="text-azul-marino-800 text-sm leading-relaxed">${escapeHtml(text)}</p>
              <span class="text-azul-marino-400 text-xs mt-1 block">${time}</span>
            </div>
          </div>`;

      chatMessages.insertAdjacentHTML('beforeend', messageHTML);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        toggleChat();
      }
    });

    // Exponer funciones para debug
    window.clearChatHistory = clearConversation;
    window.getChatSessionId = () => { console.log('Session ID:', sessionId); return sessionId; };
    window.resetChatSession = () => { clearConversation(); console.log('New Session ID:', sessionId); };
  });
</script>
